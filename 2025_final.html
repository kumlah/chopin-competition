<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>ショパコン勝手にYouTube聴衆賞(非公式) | 2025ファイナル集計</title>
    <meta
      name="description"
      content="ショパン国際ピアノコンクール2025ファイナルのYouTube再生回数を個人的にまとめた非公式メモです。順位と関係なく伸びているコンテスタントの存在を可視化するためのページです。"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#157878" />
    <link rel="stylesheet" href="/chopin-competition/assets/css/style.css" />

    <style>
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 0.4rem 0.5rem;
      }
      th {
        background: #f0f0f0;
      }
      tbody tr:nth-child(even) {
        background: #fafafa;
      }
      .num-col {
        text-align: right;
        white-space: nowrap;
      }
      .rank-col {
        max-width: 8em;
        white-space: normal;
        word-break: break-word;
      }
      .sort-icons {
        margin-left: 0.25rem;
        font-size: 0.75rem;
        white-space: nowrap;
      }
      .sort-icon {
        cursor: pointer;
        margin-left: 0.1rem;
        color: #888;
      }
      .sort-icon.active {
        color: #000;
        font-weight: bold;
      }
      .flag-icon {
        width: 20px;
        height: 14px;
        object-fit: cover;
        vertical-align: middle;
      }
      .flags-wrap {
        display: inline-flex;
        gap: 2px;
        align-items: center;
      }
      .thumb-img {
        width: 120px;
        aspect-ratio: 16 / 9;
        object-fit: cover;
      }
      .muted {
        color: #777;
        font-size: 0.85rem;
      }
      .table-wrap {
        width: 100%;
        height: 80vh;
        overflow: auto;
        border: 1px solid #ddd;
      }
      .name-sort-label {
        font-size: 0.7rem;
        color: #666;
        margin-left: 0.25rem;
      }
    </style>
  </head>

  <body>
    <main class="main-content">
      <h1>第19回(2025)ショパン国際ピアノコンクール ファイナル再生数ランキング</h1>
      <p id="summary-line" class="muted">読み込み中…</p>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>
                名前
                <span class="sort-icons">
                  <span class="name-sort-label">EN</span>
                  <span class="sort-icon" data-key="pianistSortKey" data-dir="asc" data-type="string">▲</span>
                  <span class="sort-icon" data-key="pianistSortKey" data-dir="desc" data-type="string">▼</span>

                  <span class="name-sort-label">JP</span>
                  <span class="sort-icon" data-key="pianistJpSortKey" data-dir="asc" data-type="string">▲</span>
                  <span class="sort-icon" data-key="pianistJpSortKey" data-dir="desc" data-type="string">▼</span>
                </span>
              </th>
              <th>国</th>
              <th>年齢</th>
              <th>再生回数</th>
              <th>高評価数</th>
              <th>高評価率</th>
              <th>最終結果</th>
              <th>動画</th>
            </tr>
          </thead>
          <tbody id="ranking-body"></tbody>
        </table>
      </div>
    </main>

    <script>
      const BASE = "/chopin-competition/";
      const ROUND_KEY = "ファイナル";
      const CONTEST_REF_DATE_ISO = "2025-10-01";
      let videos = [];

      function escapeHtml(s) {
        return String(s ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      function makePianistSortKey(name) {
        if (!name) return "";
        const p = name.trim().split(/\s+/);
        if (p.length === 1) return p[0].toLowerCase();
        return `${p[p.length - 1].toLowerCase()}, ${p.slice(0, -1).join(" ").toLowerCase()}`;
      }

      function makePianistJpSortKey(reading, jp, en) {
        return (reading || "").trim() || (jp || "").trim() || (en || "").trim();
      }

      function calcAge(birth) {
        if (!birth) return null;
        const b = new Date(birth);
        const r = new Date(CONTEST_REF_DATE_ISO);
        let a = r.getFullYear() - b.getFullYear();
        if (
          r.getMonth() < b.getMonth() ||
          (r.getMonth() === b.getMonth() && r.getDate() < b.getDate())
        ) a--;
        return a;
      }

      function renderTable(list) {
        const tbody = document.getElementById("ranking-body");
        tbody.innerHTML = "";
        list.forEach(v => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${v.pianistHtml}</td>
            <td>${v.country}</td>
            <td class="num-col">${v.age ?? ""}</td>
            <td class="num-col">${v.viewCount.toLocaleString()}</td>
            <td class="num-col">${v.likeCount.toLocaleString()}</td>
            <td class="num-col">${v.likeRatio ? (v.likeRatio * 100).toFixed(2) + "%" : ""}</td>
            <td class="rank-col">${v.finalResult}</td>
            <td>
              <a href="${v.url}" target="_blank">
                <img class="thumb-img" src="https://img.youtube.com/vi/${v.videoId}/mqdefault.jpg">
              </a>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      function sortAndRender(key, dir) {
        const sorted = [...videos].sort((a, b) =>
          dir === "asc"
            ? String(a[key]).localeCompare(String(b[key]), "ja")
            : String(b[key]).localeCompare(String(a[key]), "ja")
        );
        renderTable(sorted);
      }

      async function loadAndBuild() {
        const [r, c] = await Promise.all([
          fetch(BASE + "all_rounds_view_count.json"),
          fetch(BASE + "competitors.json")
        ]);

        const rd = await r.json();
        const comps = await c.json();

        videos = comps
          .filter(c => c[ROUND_KEY])
          .map(c => {
            const en = c["名前"] || "";
            const jp = c["名前（日本語表記）"] || "";
            const reading = c["名前（日本語表記）の読み"] || "";
            let html = escapeHtml(en);
            if (jp) html += `<br><span class="muted">${escapeHtml(jp)}</span>`;

            const v = rd.videos[c[ROUND_KEY]] || { viewCount: 0, likeCount: 0 };
            return {
              videoId: c[ROUND_KEY],
              url: `https://www.youtube.com/watch?v=${c[ROUND_KEY]}`,
              pianistHtml: html,
              pianistSortKey: makePianistSortKey(en),
              pianistJpSortKey: makePianistJpSortKey(reading, jp, en),
              country: c["国"] || "",
              age: calcAge(c["生年月日"]),
              viewCount: v.viewCount,
              likeCount: v.likeCount,
              likeRatio: v.viewCount ? v.likeCount / v.viewCount : null,
              finalResult: c["賞"] || "-"
            };
          });

        document.querySelectorAll(".sort-icon").forEach(ic => {
          ic.onclick = () => sortAndRender(ic.dataset.key, ic.dataset.dir);
        });

        sortAndRender("viewCount", "desc");
      }

      loadAndBuild();
    </script>
  </body>
</html>
